<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    @@include('layout/head.html')
    <title>員工後台</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/member.css">
    <link rel="stylesheet" href="css/calendar.css">
    <link rel="stylesheet" href="css/emp.css">
</head>
<body>
    <!-- @@include('layout/header.html') -->
    <main  id="emp_data">
        <!-- 左側選單 ---------------------------->
        <section class="data_column">
            <!-- 功能欄--各細項 data_button ------------------>
            <div class="data_button">
                <input type="checkbox" id="m_data">
                <label for="m_data" class="id">
                    <div class="mem">
                        <div class="mem_icon">
                            <img :src="emp_pic">
                        </div>
                        <div class="mem_p">
                            <!-- 名字 -->
                            <p>{{empRow.EMP_NAME}}</p>
                            <!-- email -->
                            <p><span>{{empRow.EMP_EMAIL}}</span></p>                           
                        </div>
                        <img src="img/memupupdowndown.png" alt="" class="up_down">
                    </div>
                </label>
                <div class="con_data">
                    <a>工作行程</a><br>
                    <a>工作紀錄</a><br>
                    <a id="btnLogout" @click="logout">登出</a>
                </div>
            </div>
        </section>

        <!-- 員工資料 -------------------------->
        <section class="data_con">
            <!-- 資料區的頭上槓槓 -->
            <div class="title_color"></div>
            <!-- 資料區的內容盒子 data_mem------------------>
            <!-- 工作行程 -->
            <div class="data_mem emp_sch center relative">

                <!-- 月曆 -->
                <div class="emp_calendar">
                    <button class="btn_btn br btn_job" type="button">請假</button>

                    <div id="calendari"></div>
                </div>
                <!-- 我是預約明細 ------------------------------->
                <div class="data_list" id="lightbox">
                    <button type="button" class="btn_btn del_btn center" @click="close_lightbox">×</button>
                    
                    <div class="memberReserve" v-for="item in saoinfos.filter(obj=>obj.SAO_DATE == clickDate)">
                        <div class="memberReserveContent">
                            <div class="memberGrid">
                                <div class="memberGrid1">預約編號</div>
                                <div class="memberGrid2">預約時間</div>
                                <div class="memberGrid3">預約時段</div>
                                <div class="memberGrid4">預約人</div>
                                <div class="memberGrid5">預約地址</div>
                                <div class="memberGrid6">電話</div>
                                <div class="memberGrid7">預約方案</div>
                                <div class="memberGrid8">預約狀態</div>
                                <!-- ----- -->
                                <div class="memberGrid9"> {{item.SAO_NO}} </div>
                                <div class="memberGrid10"> {{item.SAO_DATE}} </div>
                                <div class="memberGrid11"> {{item.SAO_TIME}} </div>
                                <div class="memberGrid12"> {{item.SAO_NAME}} </div>
                                <div class="memberGrid13"> {{item.SAO_ADD}} </div>
                                <div class="memberGrid14"> {{item.SAO_TEL}} </div>
                                <div class="memberGrid15"> {{item.PLAN_NAME}} </div>
                                <div class="memberGrid16"> {{item.STATE}} </div>

                            </div>
                        </div>
                
                        <div class="memberReserveDetailHere">
                            <div class="memberReserveDetailAll">
                                <div class="memberReserveDetail">
                                    <div class="memberReserveD1">
                                        <div>顧客需求</div>
                                    </div>
                                    <div href="product.html" class="memberOrderD2">
                                        <p class="needs">{{item.NEEDS}}</p>
                                    </div>
                                </div>
                                <div class="memberReserveDetail">
                                    <div class="memberReserveD1">
                                        <div>顧客環境照</div>
                                    </div>
                                    <div href="product.html" class="memberOrderD2 sao_pics">
                                        <p id='none'>無</p>
                                        <img class="sao_pic1" :src="item.UPLOAD_PIC1">
                                        <img class="sao_pic2" :src="item.UPLOAD_PIC2">
                                        <img class="sao_pic3" :src="item.UPLOAD_PIC3">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 回報btn放這裡---- -->
                        <button class="btn_btn btn_report" type="button" @click="showForm(item.SAO_NO,item.SAO_DATE,item.SAO_ADD)">回報</button>
                    </div>

                </div>

                <!-- 回報 ------------------------------->
                <div class="data_list" id="report_div">
                    <form id="report_form" >
                        <button class="btn_btn del_btn center" type="button"　@click="closeForm">×</button>
                        <div class="center">
                            <h4>服務回報表單</h4>
                        </div>
                        <div>
                            <p>預約編號：<span>{{sao_no}}</span></p>
                        </div>
                        <div>
                            <p>服務時間：<span>{{sao_date}}</span></p>
                        </div>
                        <div>
                            <p>服務地址：<span>{{sao_add}}</span></p>
                        </div>
                        <div class="">
                            <p>服務心得</p>
                            <textarea cols="57" rows="5" v-model="INFO" maxlength="255"></textarea>
                        </div>
                        <!-- <div class=""><textarea cols="57" rows="5" v-model="INFO"></textarea></div> -->
                        <div class="">
                            <p>施作前照片</p>
                            <input type="file"  id="before_img" name="before_img">
                            <p>施作後照片</p>
                            <input type="file" id="after_img" name="after_img">
                        </div>
                    </form>
                    <button class="btn_btn btn_send" type="button" @click="sendReport">送出</button>
                </div>

            </div>


            <!-- 工作紀錄 -->
            <div class="data_mem">

            </div>
        </section>

    </main>
    <!-- ------------ 我是Vue分隔線 ------------ -->
        <script >
            let vm = new Vue({
                el:'#emp_data',
                data:{
                    emp_pic:'img/cus/emp_img.jpg', // 預設大頭貼
                    empRow:[],
                    saoinfos:[],
                    schinfos:[],
                    clickDate:'',
                    // ------回報
                    INFO:"",
                    // BEFORE_IMG:"",
                    // AFTER_IMG:"",
                    sao_no:"",
                    sao_date:"",
                    sao_add:"",
                },
                methods: {
                    getEmpInfo(){
                        let xhr = new XMLHttpRequest();
                        let thisVue = this;
                        xhr.onload = function(){
                            thisVue.empRow = JSON.parse(xhr.responseText);
                            console.log(thisVue.empRow);
                            if(thisVue.empRow.EMP_PIC!=''){
                                thisVue.emp_pic = "img/"+thisVue.empRow.EMP_PIC; // 大頭貼路徑
                            }  
                        }
                        xhr.open("get", "phps/getEmpInfo.php", true);
                        xhr.send(null);
                    },
                    getsao(){
                        console.log("getsao進入ㄌ");
                        let thisVue = this;
                        $.ajax({
                            url: `phps/getEmpSao.php`,
                            // data: `data=${empRow.EMP_NO}`, 
                            type: 'GET', 
                            dataType: 'json', 
                            success(res){
                                let tds = $("#calendari td");
                                thisVue.saoinfos = res;
                                // 有幾筆預約訂單跑幾次
                                

                                for(let j=0; j<tds.length; j++){
                                    // $('#lightbox .memberReserve').remove();
                                    for(let i=0; i<thisVue.saoinfos.length; i++){
                                        // console.log("SAO_DATE",thisVue.saoinfos[i].SAO_DATE);
                                        // console.log("SAO_TIME",thisVue.saoinfos[i].SAO_TIME);
                                        // for(let j=0; j<tds.length; j++){
                                        //     console.log(tds[j].dataset.date);
                                        // }
                                        
                                        if(thisVue.saoinfos[i].SAO_DATE == tds[j].dataset.date){
                                            // 早中晚點點加上reserved
                                            if(thisVue.saoinfos[i].SAO_TIME == 1){
                                                tds[j].childNodes[0].childNodes[1].childNodes[0].classList.add('reserved');
                                            }else if(thisVue.saoinfos[i].SAO_TIME==2){
                                                tds[j].childNodes[0].childNodes[1].childNodes[1].classList.add('reserved');
                                            }else if(thisVue.saoinfos[i].SAO_TIME==3){
                                                tds[j].childNodes[0].childNodes[1].childNodes[2].classList.add('reserved');
                                            };

                                            if(thisVue.saoinfos[i].SAO_TIME == 1){
                                                thisVue.saoinfos[i].SAO_TIME = "早上9~12點";
                                            }else if(thisVue.saoinfos[i].SAO_TIME == 2){
                                                thisVue.saoinfos[i].SAO_TIME = "下午12~17點";
                                            }else if(thisVue.saoinfos[i].SAO_TIME == 3){
                                                thisVue.saoinfos[i].SAO_TIME = "晚上18~21點";
                                            };
    
                                            if(thisVue.saoinfos[i].STATE == 1){
                                                thisVue.saoinfos[i].STATE = "已完成";
                                                $(".btn_report").hide();
                                            }else if(thisVue.saoinfos[i].STATE == 0){
                                                thisVue.saoinfos[i].STATE = "未完成";
                                            }; 

                                            // 需求
                                            if(thisVue.saoinfos[i].NEEDS == "" || thisVue.saoinfos[i].NEEDS == null){
                                                thisVue.saoinfos[i].NEEDS = "無"
                                            };
                                            // $(".memberReserve").append("<button class='btn_btn' type='button'>回報</button>");
                                                // $(".btn_report").hide();
                                            
                                            // 照片
                                            // if(thisVue.saoinfos[i].UPLOAD_PIC1 == "" || thisVue.saoinfos[i].UPLOAD_PIC1 == null){
                                            //     $("#none").show();
                                            //     $(".sao_pic1").hide();
                                            //     $(".sao_pic2").hide();
                                            //     $(".sao_pic3").hide();
                                            // }else{ // 有圖
                                            //     $("#none").remove();
                                            //     $(".sao_pic1").show();
                                            //     $(".sao_pic2").show();
                                            //     $(".sao_pic3").show();

                                            //     thisVue.saoinfos[i].UPLOAD_PIC1 = "img/reserve/"+thisVue.saoinfos[i].UPLOAD_PIC1;
                                            //     // $(".sao_pic1").attr("src","img/reserve/"+thisVue.saoinfos[i].UPLOAD_PIC1);
                                            //     if(thisVue.saoinfos[i].UPLOAD_PIC2 != null)
                                            //     thisVue.saoinfos[i].UPLOAD_PIC2 = "img/reserve/"+thisVue.saoinfos[i].UPLOAD_PIC2;
                                            //     if(thisVue.saoinfos[i].UPLOAD_PIC3 != null)
                                            //     thisVue.saoinfos[i].UPLOAD_PIC3 = "img/reserve/"+thisVue.saoinfos[i].UPLOAD_PIC3;
                                            // };

                                            tds[j].onclick = function (){
                                                thisVue.clickDate = tds[j].dataset.date;
                                                $("#lightbox").toggle().show();
                                                
                                                // 照片
                                            if(thisVue.saoinfos[i].UPLOAD_PIC1 == "" || thisVue.saoinfos[i].UPLOAD_PIC1 == null){
                                                $("#none").show();
                                                $(".sao_pic1").hide();
                                                $(".sao_pic2").hide();
                                                $(".sao_pic3").hide();
                                            }else{ // 有圖
                                                $("#none").hide();
                                                $(".sao_pic1").show();
                                                $(".sao_pic2").show();
                                                $(".sao_pic3").show();

                                                thisVue.saoinfos[i].UPLOAD_PIC1 = "img/reserve/"+thisVue.saoinfos[i].UPLOAD_PIC1;
                                                // $(".sao_pic1").attr("src","img/reserve/"+thisVue.saoinfos[i].UPLOAD_PIC1);
                                                if(thisVue.saoinfos[i].UPLOAD_PIC2 != null)
                                                thisVue.saoinfos[i].UPLOAD_PIC2 = "img/reserve/"+thisVue.saoinfos[i].UPLOAD_PIC2;
                                                if(thisVue.saoinfos[i].UPLOAD_PIC3 != null)
                                                thisVue.saoinfos[i].UPLOAD_PIC3 = "img/reserve/"+thisVue.saoinfos[i].UPLOAD_PIC3;
                                            };
                                                

                                            };
                                        };
                                    };
                                };
                            },
                            error(res){
                                console.log('error');
                                console.log(res);
                            },
                        });
                    },
                    getsch(){
                        let thisVue = this;
                        
                        $.ajax({
                            url: `phps/getEmpSch.php`,
                            // data: `data=${empRow.EMP_NO}`, 
                            type: 'GET', 
                            dataType: 'json',
                            success(res){
                                let tds = $("#calendari td");
                                thisVue.schinfos = res;

                                for(let i=0; i<thisVue.schinfos.length; i++){
                                    // console.log("DAY_OFF",thisVue.schinfos[i].DAY_OFF);
                                    // console.log("SCH_TIME",thisVue.schinfos[i].SCH_TIME);

                                    for(let j=0; j<tds.length; j++){
                                        if(thisVue.schinfos[i].DAY_OFF == tds[j].dataset.date){
                                            // 早中晚點點加上reserved
                                            if(thisVue.schinfos[i].SCH_TIME == 1){
                                                tds[j].childNodes[0].childNodes[1].childNodes[0].classList.add('leave');
                                            }else if(thisVue.schinfos[i].SCH_TIME==2){
                                                tds[j].childNodes[0].childNodes[1].childNodes[1].classList.add('leave');
                                            }else if(thisVue.schinfos[i].SCH_TIME==3){
                                                tds[j].childNodes[0].childNodes[1].childNodes[2].classList.add('leave');
                                            }                                        tds[j].onclick = function (){
                                                // $("#lightbox").toggle().show();
                                                // console.log($(".memberGrid9").text());
                                                $(".memberGrid9").text(thisVue.saoinfos[i].SAO_DATE);
                                                
                                            }  
                                        }
                                    }
                                }
                            },
                            error(res){
                                console.log('error');
                                console.log(res);
                            },
                        })
                    },
                    logout(){        
                        let xhr = new XMLHttpRequest();
                        xhr.onload = function(){
                            // 跳轉畫面
                            window.location.assign("backendlogin.html");       
                        }
                        xhr.open("get", "phps/logout.php", true); // 清空session
                        xhr.send(null);
                    },
                    close_lightbox(){
                        $("#lightbox").toggle().hide();
                        this.getsao();
                        this.getsch();
                    },
                    // 按下回報btn 打開回報form
                    showForm(SAO_NO,SAO_DATE,SAO_ADD){
                        $("#report_div").show();
                        this.sao_no = SAO_NO;
                        this.sao_date = SAO_DATE;
                        this.sao_add = SAO_ADD;
                        console.log(SAO_DATE);
                    },
                    closeForm(){
                        $("#report_div").hide();
                    },
                    sendReport(){
                        console.log("我要送表單");
                        let thisVue = this;
                        let formData = new FormData();

                        formData.append('sao_no', thisVue.sao_no);
                        formData.append('info', thisVue.INFO);
                        formData.append('before_img', before_img.files[0]);
                        formData.append('after_img', after_img.files[0]);

                        let xhr = new XMLHttpRequest();
                        xhr.onload = function(){
                            // console.log("這是sendReport的xhr.responseText",xhr.responseText);
                            // 送出後要清空INFO和照片
                            thisVue.INFO = "";
                            before_img.files[0] = "";
                            after_img.files[0] = "";
                        }
                        
                        xhr.open("post", "phps/sendReport.php", true);  
                        xhr.send(formData);
                    },
                },
                mounted() {
                    this.getEmpInfo();
                    this.getsao();
                    this.getsch();
                },
            });
        </script>
<!-- <script src="js/member.js"></script> -->
<script src="js/calendar_emp.js"></script>
</body>
</html>